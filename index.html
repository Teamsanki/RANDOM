<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Story Upload with Firebase</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-storage.js"></script>
    <script async src="https://telegram.org/js/telegram-widget.js?7"
        data-telegram-login="@SANKI_SMSBOT"
        data-size="large" data-radius="10" data-auth-url="/auth"></script>
    <style>
        /* Basic Styling */
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .story-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .story {
            margin: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            width: 300px;
            position: relative;
        }
        .story img, .story video {
            width: 100%;
            height: auto;
        }
        .caption {
            margin-top: 10px;
            font-size: 14px;
            color: #555;
        }
        .viewer-count {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px;
            border-radius: 50%;
        }
        .upload-container {
            margin: 20px;
            text-align: center;
        }
        /* Progress Bar Popup */
        #progress-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }
        #progress-popup {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 300px;
        }
        #progress-bar {
            width: 100%;
            height: 20px;
            background-color: #ddd;
        }
        #progress {
            height: 100%;
            width: 0;
            background-color: green;
        }
    </style>
</head>
<body>

    <div id="user-info">
        <h2>Welcome, <span id="username"></span></h2>
        <img id="profile-photo" alt="Profile Photo" width="50">
    </div>

    <div class="upload-container">
        <h3>Upload Your Story</h3>
        <input type="file" id="story-file" accept="image/*,video/*">
        <textarea id="story-caption" placeholder="Enter caption..." rows="3" cols="30"></textarea>
        <button onclick="uploadStory()">Upload</button>
    </div>

    <!-- Progress Bar Modal -->
    <div id="progress-modal">
        <div id="progress-popup">
            <h4>Uploading Story...</h4>
            <div id="progress-bar">
                <div id="progress"></div>
            </div>
        </div>
    </div>

    <div class="story-container" id="stories">
        <!-- Stories will be displayed here -->
    </div>

    <script>
        // Firebase configuration (replace with your own Firebase project config)
        const firebaseConfig = {
            apiKey: "AIzaSyAemwBwNix4TbWHA7vrh5ubQaRqEY8VWKk",
    authDomain: "social-bite-skofficial.firebaseapp.com",
    databaseURL: "https://social-bite-skofficial-default-rtdb.firebaseio.com",
    projectId: "social-bite-skofficial",
    storageBucket: "social-bite-skofficial.appspot.com",
    messagingSenderId: "239722707022",
    appId: "1:239722707022:web:57d9b173f2163e85be2b1f"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Variables for Telegram User info
        let telegramUser = { username: "", name: "", profile_photo: "" };

        // Callback to handle Telegram Login and fetch user info
        window.TelegramLoginWidget = function(user) {
            telegramUser.username = user.username;
            telegramUser.name = user.first_name + " " + user.last_name;
            telegramUser.profile_photo = user.photo_url;

            document.getElementById("username").textContent = telegramUser.name;
            document.getElementById("profile-photo").src = telegramUser.profile_photo;
        };

        let stories = [];

        // Upload Story function to Firebase with Progress Bar
        function uploadStory() {
            const fileInput = document.getElementById("story-file");
            const caption = document.getElementById("story-caption").value;

            if (!fileInput.files[0] || !caption) {
                alert("Please select a file and add a caption!");
                return;
            }

            const file = fileInput.files[0];
            const fileName = file.name;
            const storageRef = storage.ref().child('stories/' + fileName);

            // Show the progress bar modal
            document.getElementById("progress-modal").style.display = "flex";

            // Upload the file to Firebase Storage
            const uploadTask = storageRef.put(file);

            uploadTask.on('state_changed', function(snapshot) {
                // Track progress
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                document.getElementById("progress").style.width = progress + "%";
            }, function(error) {
                console.error("Error uploading file:", error);
            }, function() {
                // Get the download URL and save to Firestore
                uploadTask.snapshot.ref.getDownloadURL().then(url => {
                    // Save story info to Firestore
                    db.collection("stories").add({
                        user: telegramUser.name,  // Use name instead of username
                        photo: url,
                        caption: caption,
                        viewers: [telegramUser.username], // Initially, the uploader is the viewer
                        count: 1,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp() // To keep track of when the story was uploaded
                    }).then(() => {
                        document.getElementById("progress-modal").style.display = "none"; // Hide progress bar
                        displayStories(); // Refresh the list of stories
                    }).catch(err => {
                        console.error("Error saving story:", err);
                    });
                });
            });
        }

        // Display stories from Firestore
        function displayStories() {
            const storiesContainer = document.getElementById("stories");
            storiesContainer.innerHTML = "";

            db.collection("stories").orderBy("timestamp", "desc").get().then(querySnapshot => {
                querySnapshot.forEach(doc => {
                    const story = doc.data();
                    const storyElement = document.createElement("div");
                    storyElement.classList.add("story");

                    const storyMedia = document.createElement(story.photo.endsWith('.mp4') ? "video" : "img");
                    storyMedia.src = story.photo;
                    storyMedia.controls = true;
                    storyElement.appendChild(storyMedia);

                    const caption = document.createElement("p");
                    caption.classList.add("caption");
                    caption.textContent = story.caption;
                    storyElement.appendChild(caption);

                    const viewerCount = document.createElement("span");
                    viewerCount.classList.add("viewer-count");
                    viewerCount.textContent = story.count;
                    storyElement.appendChild(viewerCount);

                    // Display viewers if user is the uploader
                    if (story.user === telegramUser.name) {
                        const viewersList = document.createElement("div");
                        viewersList.textContent = `Viewers: ${story.viewers.join(", ")}`;
                        storyElement.appendChild(viewersList);
                    }

                    storiesContainer.appendChild(storyElement);
                });
            }).catch(err => {
                console.error("Error fetching stories:", err);
            });
        }

        // Initially load stories
        displayStories();
    </script>
</body>
</html>
